name: Feature Summary Generator

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  generate-feature-summary:
    name: Generate Feature Summary
    # Only run if the label "accepted" was just added and it's a feature request or enhancement
    if: |
      github.event.label.name == 'accepted' &&
      (contains(github.event.issue.labels.*.name, 'enhancement') ||
       contains(github.event.issue.title, '[Feature]') ||
       contains(github.event.issue.title, '[Enhancement]'))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
            
      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Generate Feature Name
        id: feature_name
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Create prompt for feature name
          cat <<EOF > name_prompt.txt
          Convert the following issue title into a short, hyphenated feature name (kebab-case), max 50 characters. 
          Output ONLY the name, no other text or explanation.
          
          Title: $ISSUE_TITLE
          EOF
          
          # Generate name
          FEATURE_NAME=$(copilot -s -p "$(cat name_prompt.txt)")
          echo "Generated feature name: $FEATURE_NAME"
          echo "FEATURE_NAME=$FEATURE_NAME" >> $GITHUB_ENV

      - name: Generate Summary Content
        id: summary_content
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Create prompt file
          cat <<EOF > summary_prompt.txt
          You are an expert technical writer. 
          Read the following Skill documentation and the Issue description. 
          Then, generate a 'summary.md' file content for the feature described in the issue, strictly following the 'feature-summary' skill guidelines. 
          Output ONLY the markdown content for the file. Do not include markdown code block fences (like \`\`\`markdown) around the output.
          
          Skill Documentation:
          EOF
          
          # Append skill content safely
          cat .agents/skills/feature-summary/SKILL.md >> summary_prompt.txt
          
          # Append issue details
          cat <<EOF >> summary_prompt.txt
          
          Issue Title: $ISSUE_TITLE
          
          Issue Body:
          $ISSUE_BODY
          EOF
          
          # Generate summary
          # We redirect output to a file to handle multi-line content correctly
          copilot -s -p "$(cat summary_prompt.txt)" > generated_summary.md

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create branch
          BRANCH_NAME="feature-summary/$FEATURE_NAME"
          git checkout -b "$BRANCH_NAME"
          
          # Create directory and move file
          mkdir -p "docs/features/$FEATURE_NAME"
          mv generated_summary.md "docs/features/$FEATURE_NAME/summary.md"
          
          # Commit
          git add "docs/features/$FEATURE_NAME/summary.md"
          git commit -m "docs: generate feature summary for $FEATURE_NAME"
          
          # Push and Create PR
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --title "docs: Feature Summary for $FEATURE_NAME" \
            --body "Auto-generated feature summary based on issue #${{ github.event.issue.number }} using the feature-summary skill." \
            --base main \
            --head "$BRANCH_NAME"